 ---
title: "rethinking solutions 5"
author: "Austin Shen"
date: "28/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggdag)
library(dagitty)
library(rethinking)

```

# Medium

### 5M1

Test scores (S), number of exercise questions completed (E), time spent studying (T). 

### 5M2

Plant growth (H), sunlight exposure (S) and temperature (T)

### 5M3

If we wanted to investigate whether a higher divorce rate influences marriage rate we could consider the following multiple regression:

```{r 5M3, echo=FALSE}

dag <- dagitty::dagitty( "dag {
  A -> D A -> M D -> M
}" )
coordinates(dag) <- list( x=c(A=0,D=1,M=2) , y=c(A=0,D=1,M=0) )
tidy_dag <- tidy_dagitty(dag)
ggdag(tidy_dag) + theme_dag()

```
In this multiple regression we want to regress the marriage rate using the divorce rate and age as variables. We can compare fitted model means to evaluate this relationship.

```{r 5M3_analysis, echo=FALSE, warning=FALSE}

data(WaffleDivorce)
d <- WaffleDivorce

d$M <- scale( d$Marriage )
d$A <- scale( d$MedianAgeMarriage )
d$D <- scale( d$Divorce )

# model of marriage rate on age and divorce rate
model_full <- quap(
  alist(
    M ~ dnorm( mu , sigma ) ,
    mu <- a + bD*D + bA*A,
    a ~ dnorm( 0 , 0.2 ),
    bD ~ dnorm( 0 , 0.5 ),
    bA ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = d
) 

# model of marriage rate and age
model_A <- quap(
  alist(
    M ~ dnorm( mu , sigma ),
    mu <- a + bA * A ,
    a ~ dnorm( 0 , 0.2 ),
    bA ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = d
)

# model of marriage rate on divorce rate
model_D <- quap(
  alist(
    M ~ dnorm( mu , sigma ),
    mu <- a + bD * D,
    a ~ dnorm( 0 , 0.2 ),
    bD ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = d
)

plot( coeftab(model_A, model_D, model_full), par=c("bA","bD") )

```
The top three represent the mean and std coefficient for age in the model while the bottom three represent the mean/std of marriage rate coefficient. Marriage rate coefficient goes to zero when accounting for age. Suggests that it is not an important parameter in the relationship.

We could also show this by plotting the residuals.

### 5M4

```{r 5M4, echo=FALSE, message=FALSE}

library(dplyr)
library(stringr)

# merge Mormon population statistic
lds = read.csv(file="lds.csv", header=FALSE) %>% 
  mutate(Percent = as.numeric(str_replace(V2, "%", "")) / 100.0) %>%
  subset(select = c(V1, Percent))

names(lds) = c("Location", "LDSPercent")
d_upd = merge(d, lds, by="Location")

# scale parameters
d_upd$M <- scale( d_upd$Marriage )
d_upd$A <- scale( d_upd$MedianAgeMarriage )
d_upd$P <- scale( d_upd$LDSPercent )

# estimate reasonable prior
model_full <- quap(
  alist(
    D ~ dnorm( mu , sigma ) ,
    mu <- a + bM*M + bA*A + bP*P,
    a ~ dnorm( 0 , 0.2 ),
    bM ~ dnorm( 0 , 0.5 ),
    bA ~ dnorm( 0 , 0.5 ),
    bP ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = d_upd
)

precis(model_full)

```

Appears that increases in Mormon populations by % does tend to decrease the rate of divorce. 

### 5M5

We have the following variables:

* Obesity (O)
* Fuel price (F)
* Driving distance (D)
* Hours of exercise (E)
* Spending at restaurants (R)

We could use the following multiple regressions to explore causation by comparing the coefficients:

1. For the obesity, driving and exercise relationship:

$O = \alpha{} + \beta{}_{D}D + \beta{}_{E}E$
$O = \alpha{} + \beta{}_{E}E$
$O = \alpha{} + \beta{}_{D}D$

These comparisons will determine the direct impact of exercise and driving distance on obesity without fuel price, and the potential causal relationship between exercise and driving.

2. For the obesity, driving and restaurant spending relationship:

$O = \alpha{} + \beta{}_{D}D + \beta{}_{R}R$
$O = \alpha{} + \beta{}_{R}R$

Here we do the same for driving and restaurant spending (but we have our driving multiple regression already from 1.)

3. For obesity against all of the variables and fuel price:

$O = \alpha{} + \beta{}_{F}F$
$O = \alpha{} + \beta{}_{F}F + \beta{}_{D}D + \beta{}_{E}E + \beta{}_{R}R$

And now we can compare obesity and fuel price directly, then use a multiple regression with all variables to see how the coefficients change when all are introduced. Coefficients that reduce to near zero in the full model compared to earlier multiple regressions are spurious associations.

### 5H1

```{r 5H1, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

data(foxes)

# scale variables
foxes$W <- scale( foxes$weight )
foxes$A <- scale( foxes$area )
foxes$GS <- scale( foxes$groupsize )

# create multiple regressions
model.A <- quap(
  alist(
    W ~ dnorm( mu , sigma ),
    mu <- a + bA * A ,
    a ~ dnorm( 0 , 0.2 ),
    bA ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = foxes
)

# generate domain that spans the range of our real dataset
A.seq = seq(from = min(foxes$A), to = max(foxes$A), length.out = 100)

# sample the posterior for each value of the domain
mu.A <- link( model.A , data=data.frame(A=A.seq) )

# summarise distribution of sampled data
mu.mean.A <- apply( mu.A , 2 , mean )
mu.HPDI.A <- apply( mu.A , 2 , HPDI , prob=0.95 )

# plot
plot( W ~ A, data = foxes, col = col.alpha(rangi2, 0.5), main="Weight ~ Area" ) +
  lines( A.seq , mu.mean.A ) +
  shade( mu.HPDI.A , A.seq )

model.GS <- quap(
  alist(
    W ~ dnorm( mu , sigma ),
    mu <- a + bGS * GS ,
    a ~ dnorm( 0 , 0.2 ),
    bGS ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = foxes
)

# generate domain that spans the range of our real dataset
GS.seq = seq(from = min(foxes$GS), to = max(foxes$GS), length.out = 100)

# sample the posterior for each value of the domain
mu.GS <- link( model.GS , data=data.frame(GS=GS.seq) )

# summarise distribution of sampled data
mu.mean.GS <- apply( mu.GS , 2 , mean )
mu.HPDI.GS <- apply( mu.GS , 2 , HPDI , prob=0.95 )

# plot
plot( W ~ GS, data = foxes, col = col.alpha(rangi2, 0.5), main="Weight ~ Group size" ) +
  lines( GS.seq , mu.mean.GS ) +
  shade( mu.HPDI.GS , GS.seq )

```

It appears that there is no influence of area on fox weight but there is a small inverse relationship from group size (increasing group size leads to lower weight). 

### 5H2

```{r 5H2, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

model.W <- quap(
  alist(
    W ~ dnorm( mu , sigma ),
    mu <- a + bA * A + bGS* GS,
    a ~ dnorm( 0 , 0.2 ),
    bA ~ dnorm( 0 , 0.5 ),
    bGS ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = foxes
)

precis( model.W )

A.seq.masked <- seq(from=min(foxes$A), to=max(foxes$A), length.out=30) 
mu.A <- link( model.W , data=data.frame( A=A.seq.masked , GS=0 ) )
mu_mean.A <- apply(mu.A, 2, mean)
mu_PI.A <- apply(mu.A,2,PI) 
plot(NULL, xlim=range(foxes$A), ylim=range(foxes$W), ylab="weight", xlab="area", main="weight ~ area holding group size constant") +
  lines( A.seq.masked , mu_mean.A , lwd=2 ) +
  shade( mu_PI.A , A.seq.masked )

GS.seq.masked <- seq(from=min(foxes$GS), to=max(foxes$GS), length.out=30) 
mu.GS <- link( model.W , data=data.frame( GS=GS.seq.masked , A=0 ) )
mu_mean.GS <- apply(mu.GS, 2, mean)
mu_PI.GS <- apply(mu.GS,2,PI) 
plot(NULL, xlim=range(foxes$GS), ylim=range(foxes$W), ylab="weight", xlab="group size", main="weight ~ group size holding area size constant") +
  lines( GS.seq.masked , mu_mean.GS , lwd=2 ) +
  shade( mu_PI.GS , GS.seq.masked )

```

Already from the coefficients we can see that when using both variables in our regression the magnitude of the coefficient for both variables increases (in opposite directions) indicating there is a masked relationship between group size and area.

Plotting shows this even more clearly. This suggests that both variables are actually important in determining fox weight. Different results due to masked relationship.

### 5H3

```{r 5H3, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

foxes$F = scale(foxes$avgfood)

model.1 <- quap(
  alist(
    W ~ dnorm( mu , sigma ),
    mu <- a + bF * F + bGS* GS,
    a ~ dnorm( 0 , 0.2 ),
    bF ~ dnorm( 0 , 0.5 ),
    bGS ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = foxes
)

precis( model.1 )

model.2 <- quap(
  alist(
    W ~ dnorm( mu , sigma ),
    mu <- a + bA * A + bF * F + bGS* GS,
    a ~ dnorm( 0 , 0.2 ),
    bA ~ dnorm( 0 , 0.5 ),
    bF ~ dnorm( 0 , 0.5 ),
    bGS ~ dnorm( 0 , 0.5 ),
    sigma ~ dexp( 1 )
  ),
  data = foxes
)

precis( model.2 )

```

(a)

Not too sure.

(b)

Possibly the influence of an unknown variable that influences both food and group size. Food and group size both independently influence body weight, explaining the non-zero coefficient values in the full model. When one of the variables is removed from the model, the impact of hidden variable can be seen in the increased coefficient value of the remaining variable. Not too sure though.

